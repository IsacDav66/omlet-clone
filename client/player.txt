// client-app/player.js
const net = require('net');
const axios = require('axios');

const BACKEND_URL = 'http://localhost:3000';

async function joinRoom(salaId) {
  if (!salaId) {
    console.error('Por favor, proporciona un ID de sala. Uso: node player.js <salaId>');
    return;
  }

  try {
    console.log(`[Player] Pidiendo unirse a la sala ${salaId}...`);
    const response = await axios.post(`${BACKEND_URL}/sala/join`, {
      salaId,
      playerIp: 'mi.ip.de.jugador' // En un caso real, obtendríamos nuestra IP
    });

    const { hostIp, hostPort } = response.data;
    console.log(`[Player] Datos del host recibidos: ${hostIp}:${hostPort}. Conectando...`);

    // Conectar directamente al host
    const client = net.connect({ host: hostIp, port: hostPort }, () => {
      console.log('✅ [Player] ¡Conectado directamente al host!');
      // Enviamos un mensaje de prueba
      client.write('¡Hola host, soy un nuevo jugador!');
    });

    client.on('data', data => {
      console.log(`[Player] Recibido del host: "${data.toString().trim()}"`);
    });

    client.on('close', () => {
      console.log('[Player] Desconectado del host.');
    });
    
    client.on('error', (err) => {
      console.error(`[Player] Error de conexión: ${err.message}. ¿Está el host activo y en la misma red?`);
    });

  } catch (error) {
    console.error('[Player] Error al unirse a la sala:', error.response ? error.response.data.error : error.message);
  }
}

// Obtenemos el ID de la sala desde los argumentos de la línea de comandos
const salaId = process.argv[2];
joinRoom(salaId);